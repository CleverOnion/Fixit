version: "3.8"

# ç”Ÿäº§ç¯å¢ƒé…ç½®
services:
  postgres:
    image: postgres:17-alpine
    container_name: fixit-postgres
    ports:
      - "15432:5432"
    environment:
      POSTGRES_USER: fixit
      POSTGRES_PASSWORD: fixit
      POSTGRES_DB: fixit
      TZ: Asia/Shanghai
    command: postgres -c timezone=Asia/Shanghai
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fixit -d fixit"]
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio:latest
    container_name: fixit-minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    env_file:
      - .env
    environment:
      MINIO_CORS_ALLOW_ORIGIN: "*"
      MINIO_CORS_ALLOW_METHODS: "GET,POST,PUT,DELETE,HEAD,OPTIONS"
      MINIO_CORS_ALLOW_HEADERS: "*"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  mc:
    image: minio/mc:RELEASE.2025-08-13T08-35-41Z-cpuv1
    container_name: fixit-mc
    env_file:
      - .env
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      mc alias set myminio ${MINIO_ENDPOINT} ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD};
      mc mb myminio/${MINIO_BUCKET} --ignore-existing;
      mc anonymous set download myminio/${MINIO_BUCKET};
      echo 'MinIO initialization complete';
      sleep infinity
      "

  api:
    build:
      context: ../../fixit-api
      dockerfile: ../deploy/prod/Dockerfile.api
    container_name: fixit-api
    # åªåœ¨å†…éƒ¨ç½‘ç»œæš´éœ²ï¼Œä¸å¯¹å¤–æš´éœ²ç«¯å£
    expose:
      - "3000"
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql://fixit:fixit@postgres:5432/fixit
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    # å¯åŠ¨å‰è‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“
    command: >
      sh -c "
      echo 'ğŸ—„ï¸  Initializing database...';
      echo 'ğŸ“¦ Running database migrations...';
      npx prisma migrate deploy || echo 'Migrations already applied';
      echo 'ğŸŒ± Creating invitation codes...';
      node scripts/seed-prod.js || echo 'Seed already executed';
      echo 'ğŸš€ Starting API server...';
      node dist/src/main.js
      "

  web:
    build:
      context: ../../fixit-web
      dockerfile: ../deploy/prod/Dockerfile.web
    container_name: fixit-web
    # ä¸å¯¹å¤–æš´éœ²ç«¯å£ï¼Œåªé€šè¿‡Caddyè®¿é—®
    expose:
      - "80"

  # Caddy åå‘ä»£ç† - ç»Ÿä¸€å…¥å£
  caddy:
    image: caddy:latest
    container_name: fixit-caddy
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # HTTP/3
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    environment:
      - ACME_AGREE=true
    restart: unless-stopped
    depends_on:
      - web
      - api

volumes:
  postgres_data:
  minio_data:
  caddy_data:
  caddy_config:
